"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const axios_1 = __importDefault(require("axios"));
function check() {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            // Fetch service index to get registration base URL
            const indexUrl = 'https://api.nuget.org/v3/index.json';
            console.log(`Fetching ${indexUrl}...`);
            const indexResp = yield axios_1.default.get(indexUrl);
            const resources = indexResp.data.resources;
            const regResource = resources.find((r) => r['@type'] === 'RegistrationsBaseUrl/3.6.0');
            if (!regResource) {
                console.error('RegistrationsBaseUrl/3.6.0 not found');
                return;
            }
            const regUrl = regResource['@id'];
            console.log(`Registration URL: ${regUrl}`);
            // Fetch package registration index
            const packageId = 'newtonsoft.json';
            const packageUrl = `${regUrl}${packageId.toLowerCase()}/index.json`;
            console.log(`Fetching ${packageUrl}...`);
            const pkgResp = yield axios_1.default.get(packageUrl);
            // Find a version that might have vulnerabilities
            // Newtonsoft.Json 13.0.1 has known vulnerabilities? actually maybe 9.0.1
            // Let's check the items
            for (const page of pkgResp.data.items) {
                if (page.items) {
                    for (const item of page.items) {
                        if (item.catalogEntry.vulnerabilities) {
                            console.log(`Found vulnerabilities for ${item.catalogEntry.version}:`);
                            console.log(JSON.stringify(item.catalogEntry.vulnerabilities, null, 2));
                            return;
                        }
                    }
                }
                else {
                    // fetch page
                    const pageResp = yield axios_1.default.get(page['@id']);
                    for (const item of pageResp.data.items) {
                        if (item.catalogEntry.vulnerabilities) {
                            console.log(`Found vulnerabilities for ${item.catalogEntry.version}:`);
                            console.log(JSON.stringify(item.catalogEntry.vulnerabilities, null, 2));
                            return;
                        }
                    }
                }
            }
            console.log('No vulnerabilities found in the sampled pages.');
        }
        catch (e) {
            console.error(e);
        }
    });
}
check();
//# sourceMappingURL=verify_nuget_vulnerability.js.map